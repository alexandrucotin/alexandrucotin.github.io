---
layout: post
title:  "Django多环境配置settings"
date:   2015-12-21
desc: "Django多环境配置settings"
keywords: "python,django,settings"
categories: [Python]
tags: [django,settings]
icon: icon-python
---

在Django中的settings.py中可以修改130多项设置, 但大多数都继承自默认值. 设置是在web服务器启动时首次载入的, 服务器重启时重新载入, 因此, 程序员们应尽量避免修改正式服务器上使用的settings.py文件. 以下是一些我们应当遵循的原则:

* 所有的设置文件应当进行版本管理
* 不要重复自己 (don't repeat yourself)
* 妥善保存关键信息

之前, 我们采用的方法是, 不将设置文件放入git库中, 每个开发人员本地有一份自己的设置文件. 但我们发现这样做是错误的. 因为:

* 在debug之前, 我们可能已经花费了大量精力去模拟正式服务器上出现的错误, 但最终发现这是由于正式服务器的settings文件设置和本地不同而 出现的问题. 这时你的心情会是怎样?
* 当你在开发django项目时, 发现并修复了一个bug. 当将这一commit push到服务器后, 你突然发现这一bug的出现完全是因为你修改了本地的 settings文件而产生的, 而由于你的push, 又导致了服务器的宕机. 这时你又会是怎样的感受?
* 每个人都会从另一个程序员那里拷贝/黏贴settings文件内容, 这难道不是违反了"不要重复自己"的原则吗?

正式由于这些问题, 所以我们现在采用不一样的设置方式. 我们首先建立一个基本的设置文件, 然后将开发和正式部署的设置文件分离成不同的模块, 但 这些模块都继承自同一个基本设置文件:

#### 使用分离式的设置文件
django项目建立时, 会自动生成settings.py文件. 为了实现分离式的设置文件, 我们首先删除settings.py, 然后建立settings目录:

```
settings/
        __init__.py
        base.py
        local.py
        test.py
        production.py
        ...
```

| 设置文件 | 目的 |
|:------ |:---- |
| base.py | 基本设置文件, 在各个环境中都相同的设置可以放入其中. |
| dev.py | 当在开发时使用的设置文件. 可以设置开发时的选项, 包括DEBUG, log的等级, 是否开启例如 django-debug-toolbar等开发工具等. |
| test.py | 运行test时的配置, 包括test runners, in-memory数据库定义和log设置等. |
| product.py | 当部署到正式服务器上所用的设置. |

我们可以使用以下命令使用这些不同的设置文件:

```
python manage.py shell --settings=mysite.settings.local
python manage.py runserver --settings=mysite.settings.local
```

当然如果你熟悉 DJANGO_SETTINGS_MODULE 和 PYTHONPATH 的话, 也可以事先设置好 DJANGO_SETTINGS_MODULE 和 PYTHONPATH 环境变量, 这样做的好处就是你不必使用--settings了.

如果你对virtualenv有深入的了解的话, 也可以在postactivate脚本中设置 DJANGO_SETTINGS_MODULE 和 PYTHONPATH.

这里我使用了test.py和product.py来区分两个不同的配置：

![tree]({{ site.img_path }}/django_settings/tree.jpg)

先看__init__.py

``` python
import platform

if platform.node() == "94_54":
    from base import *
    from product import *
else:
    from base import *
    from test import *
```

其中"94_54"是正式环境的服务器的主机名，可以用hostname命令查看到

然后，我们可以在不同的py文件中（product，test）放入不同的配置，如数据库连接，其他登陆信息。

今后从仓库中拉取代码和从集成开发环境中直接打包代码文件就可以直接放入测试环境或者正式环境使用了。

base.py

``` python
"""
Django settings for saplatform project.

Generated by 'django-admin startproject' using Django 1.8.

For more information on this file, see
https://docs.djangoproject.com/en/1.8/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/1.8/ref/settings/
"""

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
import os

BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/1.8/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'za5nj^ga!a$+t8rg%9kq8j8)1ig7=s!#g!p&_$x9##8%#u0$--'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []

# Application definition

INSTALLED_APPS = (
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'app',
)

MIDDLEWARE_CLASSES = (
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.locale.LocaleMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.auth.middleware.SessionAuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'django.middleware.security.SecurityMiddleware',
)

ROOT_URLCONF = 'saplatform.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')]
        ,
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'saplatform.wsgi.application'

# Database
# https://docs.djangoproject.com/en/1.8/ref/settings/#databases

# see test.py && product.py

# Internationalization
# https://docs.djangoproject.com/en/1.8/topics/i18n/

LANGUAGE_CODE = 'zh-hans'

TIME_ZONE = 'Asia/Shanghai'

USE_I18N = True

USE_L10N = True

USE_TZ = True

# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/1.8/howto/static-files/

LOGIN_URL = '/users/login/'

STATIC_URL = '/static/'

STATICFILES_DIRS = (os.path.join(BASE_DIR, 'static'),)

# SESSION_COOKIE_AGE = 60 * 10
SESSION_EXPIRE_AT_BROWSER_CLOSE = True

```

base.py中需要注意调整的是BASE_DIR变量，需要套一层os.path.dirname()函数，因为是在settings目录下的文件。

test.py

``` python
from base import *

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': '******',
        'USER': '***',
        'PASSWORD': '******',
        'HOST': '***.***.***.***',
        'PORT': '3306',
    }
}

SALTAPI_URL = 'https://127.0.0.1:8000'

SALTAPI_USER = '****'

SALTAPI_PASSWORD = '****'
```
